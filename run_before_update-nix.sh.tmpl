#!/bin/bash

{{ if .os.linux -}}
echo "üí° Updating apt..."
sudo apt update; sudo apt upgrade -y

eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
{{ end -}}

{{ if .os.macos -}}
softwareupdate --install --all --verbose;
{{ end -}}

echo "üí° Updating homebrew..."
brew update; HOMEBREW_NO_ENV_HINTS=true brew upgrade

echo "üí° Updating dev tooling..."
. "$HOME/.asdf/asdf.sh"
asdf update
asdf install nodejs latest
asdf install ruby latest
asdf install java latest:temurin-11
asdf install java latest:temurin-17
asdf install java latest:temurin-21
asdf install maven latest
asdf install gradle latest
# asdf install python latest:3.11
# asdf install python latest:3.12
asdf install python miniconda3-3.12
asdf install golang latest
asdf install rust latest

asdf global nodejs latest
asdf global ruby latest
asdf global java latest:temurin-17
asdf global maven latest
asdf global gradle latest
asdf global python miniconda3-3.12
asdf global golang latest
asdf global rust latest

if command -v docker >/dev/null 2>&1; then
    echo "üí° Updating portainer agent..."
    # Docker commands
    docker stop portainer_agent
    docker rm portainer_agent
    docker pull portainer/agent:latest
    docker run -d -p 9001:9001 --name portainer_agent --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v /var/lib/docker/volumes:/var/lib/docker/volumes portainer/agent:latest
else
    echo "‚ö†Ô∏è Docker is not installed or not found in the path. Please install Docker."
fi
op_account_size="$(op account list --format=json | jq -r '. | length')"

if [[ "${op_account_size}" == "0" ]]; then
    echo "‚ö†Ô∏è 1password is not configured, run this command to set it up:"
    echo
    echo "   op account add --address $SUBDOMAIN.1password.com --email $LOGIN"
    echo
    exit 1
fi

eval $(op signin)

echo "üí° System initialisation done. Please open a new terminal now..."
